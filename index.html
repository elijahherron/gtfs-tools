<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Static Data GTFS Editor / Creator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
    />
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar Navigation -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <h2>GTFS Tools</h2>
        </div>
        <ul class="nav-menu">
          <li class="nav-item active" data-section="import">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <span>Import/Edit</span>
          </li>
          <li class="nav-item" data-section="create">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z"/>
              <circle cx="12" cy="12" r="3" fill="currentColor"/>
            </svg>
            <span>Create</span>
          </li>
          <ul class="nav-subitems">
            <li class="nav-subitem active" data-subsection="build">
              <span>Build</span>
            </li>
            <li class="nav-subitem" data-subsection="table">
              <span>Table</span>
            </li>
            <li class="nav-subitem" data-subsection="preview">
              <span>Preview</span>
            </li>
            <li class="nav-subitem" data-subsection="export">
              <span>Export/Save</span>
            </li>
          </ul>
          <!-- Preview is now a floating window, not a section -->
          <!-- <li class="nav-item" data-section="preview">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <span>Preview</span>
          </li> -->
          <li class="nav-item" data-section="instructions">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <circle cx="12" cy="17" r="0.5" fill="currentColor"/>
            </svg>
            <span>Instructions</span>
          </li>
        </ul>
      </nav>

      <!-- Main Content Area -->
      <main class="main-content">
        <header class="page-header">
          <h1 id="mainTitle">Eli's Static Data GTFS Editor / Creator</h1>
          <p>Create and edit GTFS files with ease</p>
        </header>

        <!-- (view-toggle moved into individual sections so it appears only where relevant) -->

        <!-- Import/Edit Section -->
        <section class="content-section active" id="import-section">
          <div class="section-header">
            <h2>Import & Edit GTFS Data</h2>
            <p>Upload an existing GTFS feed and edit it in table format</p>
          </div>
          <div class="upload-section">
        <h2>Upload GTFS .zip to visualize and edit</h2>
        <div class="upload-options">
          <div class="upload-option">
            <label for="gtfsUpload">Upload from local file:</label>
            <input type="file" id="gtfsUpload" accept=".zip" />
          </div>
          <div class="upload-option">
            <label for="gtfsUrl">Or load from URL:</label>
            <input
              type="text"
              id="gtfsUrl"
              placeholder="https://example.com/gtfs.zip"
            />
          </div>
        </div>
        <button id="uploadBtn">Upload GTFS</button>
        <div id="uploadStatus"></div>
        <div id="agencyInfo" style="display: none">
          <div id="feedInfoDisplay" class="feed-info-display">
            <div class="feed-info-grid">
              <div class="feed-info-item">
                <span class="feed-info-label">Agency Name:</span>
                <span id="agencyName" class="feed-info-value">-</span>
              </div>
              <div class="feed-info-item">
                <span class="feed-info-label">feed_info dates:</span>
                <span id="feedDates" class="feed-info-value">-</span>
              </div>
              <div class="feed-info-item">
                <span class="feed-info-label">Routes:</span>
                <span id="routeCount" class="feed-info-value">-</span>
              </div>
              <div class="feed-info-item">
                <span class="feed-info-label">fare_media types:</span>
                <span id="fareInfo" class="feed-info-value">-</span>
              </div>
            </div>
          </div>
          <div
            id="feedExpirationWarning"
            class="feed-expiration-warning"
            style="display: none"
          >
            <span class="warning-icon">⚠️</span>
            <span class="warning-text">This feed expires soon!</span>
          </div>
          <button id="agencyWebsiteBtn" class="agency-website-btn">
            Visit Agency Website
          </button>
        </div>
      </div>
          <!-- View toggle buttons for switching between table and map (Import section) -->
          <div class="view-toggle" style="margin: 10px 0; display: none">
            <button class="view-btn active" data-view="table">Table View</button>
            <button class="view-btn" data-view="map">Map View</button>
          </div>
          <!-- Table Editor (shown after upload) -->
          <div class="editor-section" id="editorSection" style="display: none">
            <h2 id="editorTitle" style="display: none; margin-bottom: 20px">
              Editing GTFS Data
            </h2>

            <div class="editor-header">
              <div class="file-tabs" id="fileTabs"></div>
            </div>

            <div class="editor-content">
              <div class="table-view" id="tableView">
                <div class="table-container" id="tableContainer"></div>
              </div>
              <!-- Editor Map View for Import/Edit (hidden until Map View selected) -->
              <div class="map-view" id="editorMapView" style="display: none">
                <!-- Route/Trip Filter for Import Section -->
                <div class="route-trip-filter" id="editorRouteTripFilter" style="display: none">
                  <div class="filter-header">
                    <h3>Filter Routes & Trips</h3>
                  </div>
                  <div class="filter-content">
                    <div class="filter-section">
                      <label for="editorRouteFilterSearch">Route:</label>
                      <div class="searchable-select" id="editorRouteSearchContainer">
                        <input
                          type="text"
                          id="editorRouteFilterSearch"
                          placeholder="Click to select or type to search routes..."
                          autocomplete="off"
                        />
                        <div class="search-dropdown" id="editorRouteSearchDropdown"></div>
                      </div>
                    </div>

                    <div class="filter-section">
                      <label for="editorTripFilterSearch">Trip:</label>
                      <div class="searchable-select" id="editorTripSearchContainer">
                        <input
                          type="text"
                          id="editorTripFilterSearch"
                          placeholder="Select route first..."
                          disabled
                          autocomplete="off"
                        />
                        <div class="search-dropdown" id="editorTripSearchDropdown"></div>
                      </div>
                    </div>

                    <div class="filter-actions">
                      <button id="editorApplyFilterBtn" class="filter-btn">
                        Show on Map
                      </button>
                      <button id="editorClearFilterBtn" class="filter-btn secondary">
                        Clear Filter
                      </button>
                    </div>
                  </div>
                </div>

                <div id="editorMapContainer" style="height: 600px; width: 100%"></div>
              </div>
            </div>

            <div class="actions" style="display: none;">
              <div class="table-actions">
                <button id="addRowBtn">Add Row</button>
                <button id="deleteRowBtn">Delete Selected</button>
              </div>
            </div>

            <!-- Export Actions for Import Section -->
            <div class="export-actions-inline" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; display: none;" id="importExportActions">
              <h3 style="margin-top: 0;">Export & Save</h3>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="saveWorkBtnImport" class="action-button">Save Work (JSON)</button>
                <button id="downloadBtnImport" class="action-button">Download GTFS</button>
                <a href="https://gtfs-validator.mobilitydata.org/" target="_blank" class="validate-link action-button">Validate Feed</a>
              </div>
            </div>
          </div>
        </section>

        <!-- Create Section -->
        <section class="content-section" id="create-section">
          <div class="section-header">
            <h2>Create New GTFS Feed</h2>
            <p>Build routes, trips, and stops visually on the map</p>
          </div>

          <!-- Empty state before creation starts -->
          <div class="create-empty-state" id="createEmptyState">
            <div class="empty-state">
              <div class="empty-state-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
                  <path d="M1 6v16l7-4 8 4 7-4V2l-7 4-8-4-7 4z"/>
                  <circle cx="12" cy="12" r="3" fill="currentColor"/>
                </svg>
              </div>
              <h3>Start Building Your GTFS Feed</h3>
              <p>Choose how you want to begin creating your transit data</p>
            </div>
            <div class="create-options">
              <div class="create-option-card">
                <h4>Create New Feed</h4>
                <p>Start with a fresh GTFS feed and build routes, stops, and schedules from scratch using the map editor</p>
                <button id="createNewBtn" class="create-option-button">Create New Feed</button>
              </div>
              <div class="create-option-card">
                <h4>Load Previous Work</h4>
                <p>Continue working on a previously saved GTFS project (JSON format)</p>
                <button id="loadWorkBtn" class="create-option-button secondary">Load Previous Work</button>
                <input type="file" id="loadWorkFile" accept=".json" style="display: none" />
              </div>
            </div>
            <!-- View toggle buttons for switching between table and map (Create section) -->
            <div class="view-toggle" style="margin: 10px 0; display: none">
              <button class="view-btn active" data-view="table">Table View</button>
              <button class="view-btn" data-view="map">Map View</button>
            </div>
            <!-- Instructions placeholder for Create section (showInstructions will prefer this) -->
            <div id="createInstructions" style="display: none; margin-top: 12px"></div>
          </div>

          <!-- Build Subsection (Map View with Sidebar) -->
          <div class="create-subsection" id="buildSubsection" style="display: none">
            <div class="build-layout">
              <!-- Left: Map View -->
              <div class="build-map-container">
                <div class="map-view" id="mapView">
                  <!-- Map Container - Full Background -->
                  <div id="mapContainer">
                    <button id="toggleCreatorBtn" class="toggle-creator-btn" title="Hide Route Creator">
                      ←
                    </button>
                    <button id="toggleSidebarBtn" class="toggle-sidebar-btn" title="Show Route Info">
                      ←
                    </button>

                    <!-- Orient Map Bar - Permanent at top -->
                    <div class="orient-map-bar">
                      <input
                        type="text"
                        id="locationSearchInput"
                        placeholder="Search location to center map... (Press Enter)"
                      />
                    </div>

                    <div id="mapLoading" class="map-loading">
                      <div class="loading-spinner"></div>
                      <p>Loading map...</p>
                    </div>
                  </div>

                  <!-- Floating Route & Trip Creator Panel -->
                  <div class="map-toolbar">
              <!-- Route/Trip Filter Dropdown for Uploaded GTFS -->
              <div
                class="route-trip-filter"
                id="routeTripFilter"
                style="display: none"
              >
                <div class="filter-header" id="filterHeader">
                  <h3>Filter Routes & Trips</h3>
                  <button
                    class="collapse-filter-btn"
                    id="collapseFilterBtn"
                    title="Collapse/Expand Filter"
                  >
                    −
                  </button>
                </div>
                <div class="filter-content" id="filterContent">
                  <div class="filter-section">
                    <label for="routeFilterSearch">Route:</label>
                    <div class="searchable-select" id="routeSearchContainer">
                      <input
                        type="text"
                        id="routeFilterSearch"
                        placeholder="Click to select or type to search routes..."
                        autocomplete="off"
                      />
                      <div
                        class="search-dropdown"
                        id="routeSearchDropdown"
                      ></div>
                    </div>
                  </div>

                  <div class="filter-section">
                    <label for="tripFilterSearch">Trip:</label>
                    <div class="searchable-select" id="tripSearchContainer">
                      <input
                        type="text"
                        id="tripFilterSearch"
                        placeholder="Select route first..."
                        disabled
                        autocomplete="off"
                      />
                      <div
                        class="search-dropdown"
                        id="tripSearchDropdown"
                      ></div>
                    </div>
                  </div>

                  <div class="filter-actions">
                    <button id="applyFilterBtn" class="filter-btn">
                      Show on Map
                    </button>
                    <button id="clearFilterBtn" class="filter-btn secondary">
                      Clear Filter
                    </button>
                  </div>
                </div>
              </div>

              <div class="route-creator">
                <div class="route-creator-header" id="routeCreatorHeader">
                  <h3>Route & Trip Creator</h3>
                </div>
                <div class="route-creator-content" id="routeCreatorContent">

                  <!-- Mode Selection Screen -->
                  <div class="creator-section" id="modeSelectionSection">
                    <h4>What would you like to do?</h4>
                    <div class="mode-selection-buttons">
                      <button id="modeCreateRouteBtn" class="mode-selection-button">
                        <div class="mode-icon">➕</div>
                        <div class="mode-title">Create Route</div>
                        <div class="mode-description">Create a new route and add trips to it</div>
                      </button>
                      <button id="modeEditRouteBtn" class="mode-selection-button" disabled>
                        <div class="mode-icon">🛤️</div>
                        <div class="mode-title">Routes</div>
                        <div class="mode-description">View and edit existing route details</div>
                      </button>
                      <button id="modeCreateTripBtn" class="mode-selection-button" disabled>
                        <div class="mode-icon">🚌</div>
                        <div class="mode-title">Trips</div>
                        <div class="mode-description">Create, view, and manage trips</div>
                      </button>
                      <button id="modeFeedInfoBtn" class="mode-selection-button">
                        <div class="mode-icon">ℹ️</div>
                        <div class="mode-title">Feed Info</div>
                        <div class="mode-description">Edit feed metadata and contact information</div>
                      </button>
                    </div>
                  </div>

                  <!-- Route Creation Section -->
                  <div class="creator-section" id="routeSection" style="display: none">
                    <div class="section-header-with-back">
                      <h4>1. Create Route</h4>
                      <button id="backToMenuFromRouteBtn" class="back-to-menu-btn">← Back to Menu</button>
                    </div>
                    <div class="route-inputs">
                      <div class="input-group">
                        <label for="routeNameInput">Route Short Name:</label>
                        <input
                          type="text"
                          id="routeNameInput"
                          placeholder="1"
                        />
                      </div>
                      <div class="input-group">
                        <label for="routeLongNameInput">Route Long Name:</label>
                        <input
                          type="text"
                          id="routeLongNameInput"
                          placeholder="Main Street Line"
                        />
                      </div>
                      <div class="input-group">
                        <label for="routeTypeSelect">Type:</label>
                        <select id="routeTypeSelect">
                          <option value="3">Bus</option>
                          <option value="0">Tram/Light Rail</option>
                          <option value="1">Subway/Metro</option>
                          <option value="2">Rail</option>
                          <option value="4">Ferry</option>
                        </select>
                      </div>
                      <div class="input-group">
                        <label for="routeColorInput">Route Color:</label>
                        <div class="color-input-group">
                          <input
                            type="color"
                            id="routeColorInput"
                            value="#4caf50"
                          />
                          <input
                            type="text"
                            id="routeColorHex"
                            value="#4caf50"
                            placeholder="#RRGGBB"
                            maxlength="7"
                          />
                        </div>
                      </div>
                      <div class="input-group">
                        <label for="routeTextColorInput">Text Color:</label>
                        <div class="color-input-group">
                          <input
                            type="color"
                            id="routeTextColorInput"
                            value="#ffffff"
                          />
                          <input
                            type="text"
                            id="routeTextColorHex"
                            value="#ffffff"
                            placeholder="#RRGGBB"
                            maxlength="7"
                          />
                        </div>
                      </div>
                      <div
                        style="
                          grid-column: span 3;
                          text-align: center;
                          margin-top: 10px;
                        "
                      >
                        <button
                          type="button"
                          class="contrast-check-btn"
                          onclick="
                            const bgColor = document.getElementById('routeColorHex').value.replace('#', '');
                            const textColor = document.getElementById('routeTextColorHex').value.replace('#', '');
                            window.open(`https://coolors.co/contrast-checker/${textColor}-${bgColor}`, '_blank');
                          "
                        >
                          Check Contrast
                        </button>
                      </div>
                    </div>
                    <div class="create-action-area">
                      <button id="createRouteBtn" class="create-option-button">Create Route</button>
                      <button id="selectExistingRouteBtn" class="create-option-button secondary">
                        Use Existing Route
                      </button>
                    </div>
                  </div>

                  <!-- Route Selection Section -->
                  <div
                    class="creator-section"
                    id="routeSelectSection"
                    style="display: none"
                  >
                    <h4>Select Existing Route</h4>
                    <select id="existingRouteSelect">
                      <option value="">Choose a route...</option>
                    </select>
                    <button id="selectRouteBtn">Select Route</button>
                    <button id="cancelSelectBtn">Cancel</button>
                  </div>

                  <!-- Trip Creation Section -->
                  <div
                    class="creator-section"
                    id="tripSection"
                    style="display: none"
                  >
                    <h4>
                      2. Create Trip
                      <span
                        id="currentRouteIndicator"
                        style="
                          color: #666;
                          font-weight: normal;
                          font-size: 0.9em;
                        "
                      ></span>
                    </h4>

                    <!-- Trip Creation Method -->
                    <div class="trip-creation-method">
                      <div class="input-group">
                        <label for="tripCreationMethodSelect"
                          >Trip Creation Method:</label
                        >
                        <select id="tripCreationMethodSelect">
                          <option value="scratch">Create from scratch</option>
                          <option value="copy">Copy from existing trip</option>
                        </select>
                      </div>
                    </div>

                    <!-- Copy Trip Selection -->
                    <div
                      class="copy-trip-section"
                      id="copyTripSection"
                      style="display: none"
                    >
                      <div class="input-group">
                        <label for="copyFromTripSelect"
                          >Select Trip to Copy:</label
                        >
                        <select id="copyFromTripSelect">
                          <option value="">Choose an existing trip...</option>
                        </select>
                      </div>
                      <div class="input-group">
                        <label>
                          <input type="checkbox" id="changeStartTimeCheckbox" />
                          Change start time
                        </label>
                      </div>
                      <div class="input-group" id="newStartTimeGroup" style="display: none">
                        <label for="newStartTimeInput">New start time:</label>
                        <input
                          type="time"
                          id="newStartTimeInput"
                        />
                      </div>
                      <button
                        id="loadTripDataBtn"
                        class="secondary-btn"
                        disabled
                      >
                        Load Trip Data
                      </button>
                      <p class="copy-trip-description">
                        This will load all trip details (headsign, direction,
                        stops, shape, timing) which you can then modify and save
                        as a new trip. Use "Change start time" to adjust all stop
                        times while maintaining the intervals between stops.
                      </p>
                    </div>

                    <div class="trip-inputs">
                      <div class="input-group">
                        <label for="tripHeadsignInput">Trip Headsign:</label>
                        <input
                          type="text"
                          id="tripHeadsignInput"
                          placeholder="Downtown"
                        />
                      </div>
                      <div class="input-group">
                        <label for="directionSelect">Direction ID:</label>
                        <select id="directionSelect">
                          <option value="0">0</option>
                          <option value="1">1</option>
                        </select>
                      </div>
                      <div class="input-group">
                        <label for="tripShortNameInput">Trip Short Name:</label>
                        <input
                          type="text"
                          id="tripShortNameInput"
                          placeholder="Optional"
                        />
                      </div>
                      <div class="input-group">
                        <label for="wheelchairAccessibleSelect">Wheelchair Accessible:</label>
                        <select id="wheelchairAccessibleSelect">
                          <option value="">No information</option>
                          <option value="1">Accessible</option>
                          <option value="2">Not accessible</option>
                        </select>
                      </div>
                    </div>

                    <div class="calendar-section">
                      <h5>Service Calendar</h5>
                      <div class="calendar-method">
                        <label for="calendarMethodSelect"
                          >Calendar Method:</label
                        >
                        <select id="calendarMethodSelect" required>
                          <option value="">Select service option...</option>
                          <option value="existing">Use existing service</option>
                          <option value="new">Create new service</option>
                          <option value="none">
                            No Service (trips will not run)
                          </option>
                        </select>
                      </div>

                      <div class="calendar-inputs" id="existingCalendarInputs">
                        <div class="input-group">
                          <label for="existingServiceSelect"
                            >Existing Service:</label
                          >
                          <select id="existingServiceSelect">
                            <option value="">Choose a service...</option>
                          </select>
                        </div>
                      </div>

                      <div
                        class="calendar-inputs"
                        id="newCalendarInputs"
                        style="display: none"
                      >
                        <div class="input-group">
                          <label for="serviceNameInput">Service Name:</label>
                          <input
                            type="text"
                            id="serviceNameInput"
                            placeholder="weekday_service"
                          />
                        </div>
                        <div class="input-group">
                          <label>Days of Operation:</label>
                          <div class="days-checkboxes">
                            <label>
                              Monday
                              <input type="checkbox" id="mondayCheck" checked />
                            </label>
                            <label>
                              Tuesday
                              <input
                                type="checkbox"
                                id="tuesdayCheck"
                                checked
                              />
                            </label>
                            <label>
                              Wednesday
                              <input
                                type="checkbox"
                                id="wednesdayCheck"
                                checked
                              />
                            </label>
                            <label>
                              Thursday
                              <input
                                type="checkbox"
                                id="thursdayCheck"
                                checked
                              />
                            </label>
                            <label>
                              Friday
                              <input type="checkbox" id="fridayCheck" checked />
                            </label>
                            <label>
                              Saturday
                              <input type="checkbox" id="saturdayCheck" />
                            </label>
                            <label>
                              Sunday
                              <input type="checkbox" id="sundayCheck" />
                            </label>
                          </div>
                        </div>
                        <div class="date-inputs">
                          <div class="input-group-inline">
                            <label for="startDateInput">Start Date:</label>
                            <input type="date" id="startDateInput" />
                          </div>
                          <div class="input-group-inline">
                            <label for="endDateInput">End Date:</label>
                            <input type="date" id="endDateInput" />
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="timing-section">
                      <h5>Trip Timing</h5>
                      <p class="timing-explainer">
                        <strong>Note:</strong> This section helps you quickly
                        assign stop times as you create stops. It's
                        <em>not</em> related to frequency-based service (see
                        Frequency-Based Service section below for that). This is
                        just a convenience for automatically calculating
                        arrival/departure times between stops.
                      </p>
                      <div class="timing-method">
                        <label for="timingMethodSelect"
                          >Timing Between Stops:</label
                        >
                        <select id="timingMethodSelect">
                          <option value="auto">
                            Auto-calculate with intervals (automatically sets
                            stop_times between stops)
                          </option>
                          <option value="manual" selected>
                            Set time for each stop
                          </option>
                        </select>
                      </div>

                      <div
                        class="timing-inputs"
                        id="autoTimingInputs"
                        style="display: none"
                      >
                        <div class="input-group-inline">
                          <label for="tripStartTimeInput">Start Time:</label>
                          <input
                            type="time"
                            id="tripStartTimeInput"
                            value="08:00"
                          />
                        </div>
                        <div class="input-group-inline">
                          <label for="defaultStopIntervalInput"
                            >Interval (min):</label
                          >
                          <input
                            type="number"
                            id="defaultStopIntervalInput"
                            value="2"
                            min="1"
                            max="60"
                          />
                        </div>
                      </div>

                      <div class="timing-inputs" id="manualTimingInputs">
                        <p class="timing-note">
                          You'll set arrival/departure times when adding each
                          stop
                        </p>
                      </div>
                    </div>

                    <div class="frequencies-section">
                      <h5>Frequency-Based Service</h5>
                      <div class="frequency-toggle">
                        <label for="useFrequenciesToggle" class="toggle-label">
                          <input type="checkbox" id="useFrequenciesToggle" />
                          <span class="toggle-text"
                            >Use frequency-based service</span
                          >
                        </label>
                        <p class="toggle-description">
                          Enable to create headway-based trips instead of
                          specific stop times
                        </p>
                      </div>

                      <div
                        class="frequency-inputs"
                        id="frequencyInputs"
                        style="display: none"
                      >
                        <p class="frequency-note">
                          <strong>Note:</strong> When using frequencies, only
                          the first trip needs stop times as a template.
                          Additional trips are generated automatically based on
                          headway intervals.
                        </p>

                        <div class="frequency-periods">
                          <h6>Service Periods</h6>
                          <div
                            class="frequency-period-list"
                            id="frequencyPeriodList"
                          >
                            <div class="frequency-empty">
                              No frequency periods defined
                            </div>
                          </div>

                          <div class="add-frequency-period">
                            <div class="frequency-period-inputs">
                              <div class="input-group-inline">
                                <label for="frequencyStartInput"
                                  >Start Time:</label
                                >
                                <input
                                  type="time"
                                  id="frequencyStartInput"
                                  value="06:00"
                                />
                              </div>
                              <div class="input-group-inline">
                                <label for="frequencyEndInput">End Time:</label>
                                <input
                                  type="time"
                                  id="frequencyEndInput"
                                  value="22:00"
                                />
                              </div>
                              <div class="input-group-inline">
                                <label for="headwaySecsInput"
                                  >Headway (minutes):</label
                                >
                                <input
                                  type="number"
                                  id="headwaySecsInput"
                                  value="15"
                                  min="1"
                                  max="120"
                                />
                              </div>
                              <div class="input-group-inline">
                                <label for="exactTimesSelect">Timing:</label>
                                <select id="exactTimesSelect">
                                  <option value="0">Exact times</option>
                                  <option value="1">Approximate times</option>
                                </select>
                              </div>
                            </div>
                            <button
                              id="addFrequencyPeriodBtn"
                              class="add-frequency-btn"
                            >
                              Add Period
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="trip-continuation-section">
                      <h5>Trip Continuation</h5>
                      <div class="continuation-toggle">
                        <label for="useContinuationToggle" class="toggle-label">
                          <input type="checkbox" id="useContinuationToggle" />
                          <span class="toggle-text"
                            >This trip continues as another trip</span
                          >
                        </label>
                        <p class="toggle-description">
                          Enable to indicate this trip continues as another trip (passengers stay on vehicle)
                        </p>

                        <div class="continuation-settings" id="continuationSettings" style="display: none">
                          <div class="input-group">
                            <label for="continuationTripSelect">Continues as:</label>
                            <select id="continuationTripSelect">
                              <option value="">Select a trip...</option>
                            </select>
                          </div>

                          <div class="input-group">
                            <label for="continuationTypeSelect">Transfer Type:</label>
                            <select id="continuationTypeSelect">
                              <option value="4">Type 4 - In-seat transfer allowed (passengers stay on vehicle)</option>
                              <option value="5">Type 5 - In-seat transfer not allowed (passengers must re-board)</option>
                            </select>
                          </div>

                          <div class="input-group" id="continuationMinTimeGroup" style="display: none">
                            <label for="continuationMinTimeInput">Minimum Transfer Time (seconds):</label>
                            <input
                              type="number"
                              id="continuationMinTimeInput"
                              placeholder="e.g., 60"
                              min="0"
                            />
                            <small>Time required for passengers to alight and re-board (for Type 5)</small>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="stop-naming-section">
                      <h5>Stop Naming</h5>
                      <div class="naming-toggle">
                        <label for="useStreetNamesToggle" class="toggle-label">
                          <input type="checkbox" id="useStreetNamesToggle" />
                          <span class="toggle-text"
                            >Use street-based stop names</span
                          >
                        </label>
                        <p class="toggle-description">
                          Enable to automatically name stops using nearby street intersections
                        </p>
                      </div>
                    </div>

                    <div class="trip-buttons">
                      <button id="startTripBtn">Start Creating Trip</button>
                      <button id="finishTripBtn" disabled>Save Trip</button>
                      <button id="clearTripBtn">Clear Trip</button>
                      <button id="backToRouteBtn">Back to Route</button>
                    </div>
                  </div> <!-- Close tripSection -->

                  <!-- Routes Manager Section -->
                  <div class="creator-section" id="editRouteSection" style="display: none">
                    <div class="section-header-with-back">
                      <h4>Routes Manager</h4>
                      <button id="backToMenuFromEditBtn" class="back-to-menu-btn">← Back to Menu</button>
                    </div>

                    <div class="input-group">
                      <label for="editRouteSelect">Select Route:</label>
                      <select id="editRouteSelect">
                        <option value="">Choose a route...</option>
                      </select>
                    </div>

                    <div id="editRouteDetails" style="display: none">
                      <h5>Route Details</h5>
                      <div class="route-inputs">
                        <div class="input-group">
                          <label for="editRouteNameInput">Route Short Name:</label>
                          <input type="text" id="editRouteNameInput" placeholder="1" />
                        </div>
                        <div class="input-group">
                          <label for="editRouteLongNameInput">Route Long Name:</label>
                          <input type="text" id="editRouteLongNameInput" placeholder="Main Street Line" />
                        </div>
                        <div class="input-group">
                          <label for="editRouteTypeSelect">Type:</label>
                          <select id="editRouteTypeSelect">
                            <option value="3">Bus</option>
                            <option value="0">Tram/Light Rail</option>
                            <option value="1">Subway/Metro</option>
                            <option value="2">Rail</option>
                            <option value="4">Ferry</option>
                          </select>
                        </div>
                        <div class="input-group">
                          <label for="editRouteColorInput">Route Color:</label>
                          <div class="color-input-group">
                            <input type="color" id="editRouteColorInput" value="#4caf50" />
                            <input type="text" id="editRouteColorHex" value="#4caf50" placeholder="#RRGGBB" maxlength="7" />
                          </div>
                        </div>
                        <div class="input-group">
                          <label for="editRouteTextColorInput">Text Color:</label>
                          <div class="color-input-group">
                            <input type="color" id="editRouteTextColorInput" value="#ffffff" />
                            <input type="text" id="editRouteTextColorHex" value="#ffffff" placeholder="#RRGGBB" maxlength="7" />
                          </div>
                        </div>
                      </div>
                      <button id="saveRouteEditsBtn" class="create-option-button">Save Route Changes</button>
                    </div>
                  </div>

                  <!-- Trips Manager Section -->
                  <div class="creator-section" id="createTripOnlySection" style="display: none">
                    <div class="section-header-with-back">
                      <h4>Trips Manager</h4>
                      <button id="backToMenuFromCreateTripBtn" class="back-to-menu-btn">← Back to Menu</button>
                    </div>

                    <div class="trips-manager-content">
                      <!-- Route Selection -->
                      <div class="input-group">
                        <label for="createTripRouteSelect">Select Route:</label>
                        <select id="createTripRouteSelect">
                          <option value="">Choose a route...</option>
                        </select>
                      </div>

                      <!-- Create New Trip Button -->
                      <button id="createNewTripBtn" class="create-option-button" disabled>
                        ➕ Create New Trip on This Route
                      </button>

                      <!-- Existing Trips List -->
                      <div class="existing-trips-section" id="tripsManagerTripsSection" style="display: none">
                        <h5>Existing Trips on This Route</h5>
                        <div class="trips-list" id="tripsManagerList">
                          <div class="empty-trips-message">No trips on this route yet</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Feed Info Editor Section -->
                  <div class="creator-section" id="feedInfoSection" style="display: none">
                    <div class="section-header-with-back">
                      <h4>Feed Information</h4>
                      <button id="backToMenuFromFeedInfoBtn" class="back-to-menu-btn">← Back to Menu</button>
                    </div>

                    <div class="feed-info-editor">
                      <p class="section-description">Edit your GTFS feed metadata and contact information. Fields marked with * are required.</p>

                      <div class="route-inputs">
                        <div class="input-group">
                          <label for="feedPublisherNameInput">Publisher Name: *</label>
                          <input type="text" id="feedPublisherNameInput" placeholder="Transit Agency Name" />
                        </div>

                        <div class="input-group">
                          <label for="feedPublisherUrlInput">Publisher URL: *</label>
                          <input type="url" id="feedPublisherUrlInput" placeholder="https://example.com" />
                        </div>

                        <div class="input-group">
                          <label for="feedLangInput">Feed Language: *</label>
                          <input type="text" id="feedLangInput" placeholder="en" maxlength="2" />
                          <small>Two-letter ISO 639-1 code (e.g., en, es, fr)</small>
                        </div>

                        <div class="input-group">
                          <label for="feedDefaultLangInput">Default Language:</label>
                          <input type="text" id="feedDefaultLangInput" placeholder="en" maxlength="2" />
                          <small>Optional, two-letter ISO 639-1 code</small>
                        </div>

                        <div class="input-group">
                          <label for="feedStartDateInput">Feed Start Date:</label>
                          <input type="date" id="feedStartDateInput" />
                        </div>

                        <div class="input-group">
                          <label for="feedEndDateInput">Feed End Date:</label>
                          <input type="date" id="feedEndDateInput" />
                        </div>

                        <div class="input-group">
                          <label for="feedVersionInput">Feed Version:</label>
                          <input type="text" id="feedVersionInput" placeholder="1.0" />
                        </div>

                        <div class="input-group">
                          <label for="feedContactEmailInput">Contact Email:</label>
                          <input type="email" id="feedContactEmailInput" placeholder="contact@example.com" />
                        </div>

                        <div class="input-group">
                          <label for="feedContactUrlInput">Contact URL:</label>
                          <input type="url" id="feedContactUrlInput" placeholder="https://example.com/contact" />
                        </div>
                      </div>

                      <button id="saveFeedInfoBtn" class="create-option-button">Save Feed Info</button>
                    </div>
                  </div>

                </div> <!-- Close route-creator-content -->
              </div> <!-- Close route-creator -->
            </div> <!-- Close map-toolbar -->

            <!-- Right: Route Info Panel (floating on right side of map) -->
            <aside class="route-info-sidebar floating collapsed" id="routeInfoSidebar" aria-hidden="true">
              <!-- placeholder when no route active -->
              <div class="sidebar-placeholder" id="sidebarPlaceholder">
                <div class="placeholder-icon">📍</div>
                <h3>No Active Route</h3>
                <p>Create a new route or select an existing trip to get started.</p>
              </div>

              <!-- active content -->
              <div class="sidebar-active-content" id="sidebarActiveContent" style="display:none">
                <div class="panel-body" id="sidebarContent">
                  <section class="current-route-info">
                    <h4><span id="currentRouteName">-</span></h4>
                    <p><strong>Type:</strong> <span id="currentRouteType">-</span> | <strong>ID:</strong> <span id="currentRouteId">-</span></p>
                  </section>

                  <section class="current-trip-info">
                    <h5>Current Trip</h5>
                    <div class="trip-stats">
                      <div class="stat-item"><strong>Headsign:</strong> <span id="currentHeadsign">-</span></div>
                      <div class="stat-item"><strong>Direction:</strong> <span id="currentDirection">-</span></div>
                      <div class="stat-item"><strong>Stops:</strong> <span id="stopCount">0</span></div>
                      <div class="stat-item"><strong>Distance:</strong> <span id="routeDistance">0 km</span></div>
                    </div>
                  </section>

                  <!-- shape / stops controls preserved (kept IDs for JS) -->
                  <div class="shape-options-section">
                    <h6>Shape Options</h6>
                    <label class="toggle-label"><input type="checkbox" id="noShapesToggle"/> <span class="toggle-text">No Shapes (stops only)</span></label>
                  </div>

                  <div class="stops-list-section">
                    <h5 id="stopsListToggle">Trip Stops <span id="stopsToggleIcon">▼</span></h5>
                    <div id="stopsListContainer" class="stops-list">
                      <div id="stopsListEmpty" class="stops-empty">No stops added yet</div>
                      <ul id="stopsList" style="display:none"></ul>
                    </div>
                  </div>

                  <!-- Existing Stops Selector (allows adding stops from already imported stops.txt) -->
                  <div class="existing-stops-section" id="existingStopsSection" style="display: none; margin-top: 10px;">
                    <h5>Existing Stops</h5>
                    <div id="existingStopsContainer" class="existing-stops-container">
                      <input id="existingStopsSearch" type="text" placeholder="Click to select or type to search stops..." />
                      <div id="existingStopsDropdown" class="existing-stops-dropdown"></div>
                      <div style="margin-top:6px; text-align:right;">
                        <button id="addExistingStopBtn" class="add-stop-btn" disabled>Add Selected Stop</button>
                      </div>
                    </div>
                  </div>

                  <!-- Existing Trips Section -->
                  <div class="existing-trips-section" id="existingTripsSection" style="display: none">
                    <h5>Existing Trips on This Route</h5>
                    <div class="trips-list" id="existingTripsList">
                      <div class="empty-trips-message" id="tripsListEmpty">No trips on this route yet</div>
                    </div>
                  </div>

                  <!-- keep existing controls for adding stops by coords etc. -->
                  <div class="stop-input-section">
                    <h6>Add Stop by Coordinates</h6>
                    <div class="coord-inputs">
                      <div class="coord-group"><label for="latInput">Lat:</label><input type="number" id="latInput" step="0.000001" placeholder="40.7128"/></div>
                      <div class="coord-group"><label for="lngInput">Lng:</label><input type="number" id="lngInput" step="0.000001" placeholder="-74.0060"/></div>
                    </div>
                    <div class="coord-time-inputs" id="coordTimeInputs">
                      <div class="coord-group"><label for="coordArrivalInput">Arrival:</label><input type="time" id="coordArrivalInput"/></div>
                      <div class="coord-group"><label for="coordDepartureInput">Departure:</label><input type="time" id="coordDepartureInput"/></div>
                    </div>
                    <button id="addStopByCoordBtn" type="button" class="add-stop-btn">Add Stop</button>
                  </div>
                </div>
              </div>
            </aside>

          </div> <!-- Close mapView -->
        </div> <!-- Close build-map-container -->
            </div> <!-- Close build-layout -->
          </div> <!-- Close buildSubsection -->

          <!-- Table Subsection -->
          <div class="create-subsection" id="tableSubsection" style="display: none">
            <div class="section-header">
              <h2>GTFS Data Tables</h2>
              <p>View and edit your GTFS data in table format</p>
            </div>
            <div class="editor-header">
              <div class="file-tabs" id="createFileTabs"></div>
            </div>
            <div class="table-container" id="createTableContainer"></div>
          </div>

          <!-- Preview Subsection -->
          <div class="create-subsection" id="previewSubsection" style="display: none">
            <div class="section-header">
              <h2>Preview GTFS Feed</h2>
              <p>View your entire transit system on the map</p>
            </div>
            <div style="padding: 20px; text-align: center; color: #666;">
              <p>The preview window will open automatically. You can close it and reopen it by clicking this tab again.</p>
            </div>
          </div>

            <!-- Floating Instructions Panel -->
            <div
              class="floating-instructions"
              id="floatingInstructions"
              style="display: none"
            >
              <div class="floating-window-header">
                <div class="drag-handle">
                  <span class="window-title">📋 Instructions</span>
                </div>
                <div class="window-controls">
                  <button
                    class="collapse-btn"
                    id="collapseInstructions"
                    title="Collapse Panel"
                  >
                    +
                  </button>
                  <button
                    class="close-btn"
                    id="closeInstructions"
                    title="Hide Panel"
                  >
                    ×
                  </button>
                </div>
              </div>
              <div
                class="floating-window-content collapsed"
                id="instructionsWindowContent"
              >
                <div class="instructions-intro">
                  <p>
                    <strong>Welcome to the GTFS Creator & Editor!</strong> This
                    tool helps you build complete transit feeds with routes,
                    stops, trips, and schedules, or edit existing GTFS feeds.
                    Follow these steps to create or modify professional transit data.
                  </p>
                  <p>
                    <a
                      href="https://github.com/google/transit/blob/master/gtfs/spec/en/reference.md"
                      target="_blank"
                      class="gtfs-spec-link"
                      >📖 View Official GTFS Specification</a
                    >
                  </p>
                </div>

                <div class="instruction-steps">
                  <div class="step-section">
                    <h4>📁 Getting Started</h4>
                    <p>Choose how to begin:</p>
                    <ul>
                      <li><strong>Import & Edit:</strong> Upload an existing GTFS .zip file from your computer or via URL to edit it</li>
                      <li><strong>Create New:</strong> Click "Create New GTFS" in the sidebar to start from scratch</li>
                    </ul>
                    <p><em>💡 Tip: You can drag and drop .zip files onto the upload section!</em></p>
                  </div>

                  <div class="step-section">
                    <h4>🎯 Mode Selection</h4>
                    <p>In the <strong>Create</strong> section's <strong>Build</strong> tab, choose what you want to do:</p>
                    <ul>
                      <li><strong>➕ Create Route:</strong> Start a new route and add trips to it (full workflow)</li>
                      <li><strong>🛤️ Routes:</strong> View and edit existing route details (name, type, colors)</li>
                      <li><strong>🚌 Trips:</strong> Create, view, and manage trips on existing routes</li>
                    </ul>
                    <p><em>Note: Routes and Trips are disabled until you create your first route.</em></p>
                  </div>

                  <div class="step-section">
                    <h4>🚌 Creating a Route</h4>
                    <p>
                      Routes represent a single transit line (like "Bus Route 1"
                      or "Blue Line"). In the Route Creator panel:
                    </p>
                    <ul>
                      <li>
                        <strong>Route Short Name:</strong> Enter a concise
                        identifier (e.g., "1", "A", "Blue")
                      </li>
                      <li>
                        <strong>Route Long Name:</strong> Enter descriptive name
                        (e.g., "Main Street Line", "Downtown Express")
                      </li>
                      <li>
                        <strong>Route Type:</strong> Choose vehicle type - Bus
                        (most common), Tram, Subway, Rail, or Ferry
                      </li>
                      <li>
                        <strong>Route Colors:</strong> Pick brand colors that
                        represent your transit line
                      </li>
                      <li>
                        <strong>Orient Map:</strong> Search for your city/area
                        to center the map on your service area
                      </li>
                      <li>
                        <strong>Contrast Check:</strong> Use the contrast
                        checker to ensure colors meet accessibility standards
                      </li>
                    </ul>
                    <p>
                      <em
                        >💡 Tip: Either route short name OR route long name is required (not both).</em
                      >
                    </p>
                  </div>

                  <div class="step-section">
                    <h4>🛤️ Managing Routes</h4>
                    <p>
                      Select <strong>Routes</strong> from the mode menu to view and edit existing routes:
                    </p>
                    <ul>
                      <li>
                        <strong>Route Selector:</strong> Choose which route to edit from the dropdown
                      </li>
                      <li>
                        <strong>Edit Route Details:</strong> Modify route short name, long name, type, and colors
                      </li>
                      <li>
                        <strong>Save Changes:</strong> Click "Save Route Changes" to apply your edits
                      </li>
                    </ul>
                    <p>
                      <em>💡 Tip: Use the Trips section to manage trips on routes.</em>
                    </p>
                  </div>

                  <div class="step-section">
                    <h4>🛣️ Setting Up a Trip</h4>
                    <p>
                      Trips are specific journeys along a route (like "8:00 AM
                      Downtown to Airport"). Configure trip details:
                    </p>
                    <ul>
                      <li>
                        <strong>Trip Headsign:</strong> Destination shown to
                        passengers (e.g., "Downtown", "Airport", "City Center")
                      </li>
                      <li>
                        <strong>Direction ID:</strong> Use 0 for outbound, 1 for
                        return journey (helps organize opposite directions)
                      </li>
                      <li>
                        <strong>Trip Short Name:</strong> Optional identifier
                        for internal use
                      </li>
                    </ul>

                    <h5>📅 Service Calendar</h5>
                    <ul>
                      <li>
                        <strong>Use Existing Service:</strong> Select
                        pre-configured service patterns
                      </li>
                      <li>
                        <strong>Create New Service:</strong> Define custom
                        schedule with specific days and date ranges
                      </li>
                      <li>
                        <strong>Days Selection:</strong> Choose which days of
                        the week this trip operates
                      </li>
                    </ul>

                    <h5>⏰ Trip Timing</h5>
                    <ul>
                      <li>
                        <strong>Set time for each stop (Recommended):</strong>
                        Manually set arrival/departure times for precision
                      </li>
                      <li>
                        <strong>Auto-calculate:</strong> Generate times based on
                        start time and interval between stops
                      </li>
                    </ul>

                    <h5>🕐 Frequency-Based Service</h5>
                    <ul>
                      <li>
                        <strong>Frequency Toggle:</strong> Enable to create
                        headway-based trips instead of fixed schedules
                      </li>
                      <li>
                        <strong>Service Periods:</strong> Define different
                        headways for different times of day (e.g., peak vs
                        off-peak)
                      </li>
                      <li>
                        <strong>Headway Intervals:</strong> Set how often
                        vehicles run (e.g., every 15 minutes)
                      </li>
                      <li>
                        <strong>Exact vs Approximate:</strong> Choose whether
                        departure times are exact or approximate
                      </li>
                      <li>
                        <strong>Template Trip:</strong> Only the first trip
                        needs stop times - frequencies automatically generate
                        additional trips
                      </li>
                    </ul>

                    <h5>🎨 Shape Options</h5>
                    <ul>
                      <li>
                        <strong>Shapes Enabled (Default):</strong> Creates
                        detailed route paths showing actual vehicle movement
                      </li>
                      <li>
                        <strong>"No Shapes" Toggle:</strong> Check this to
                        create only stops without detailed route paths
                      </li>
                    </ul>
                  </div>

                  <div class="step-section">
                    <h4>🎯 Creating Stops and Route Shapes</h4>
                    <p>
                      Click <strong>"Start Creating Trip"</strong> to begin
                      placing stops and drawing your route. The workflow differs
                      based on your shape settings:
                    </p>

                    <h5>📍 With Shapes Enabled (Recommended)</h5>
                    <ul>
                      <li>
                        <strong>First Click:</strong> Creates your first stop
                        AND starts the route shape automatically
                      </li>
                      <li>
                        <strong>Normal Clicks:</strong> Add shape nodes to trace
                        the actual path vehicles follow (roads, turns, etc.)
                      </li>
                      <li>
                        <strong>Shift + Click:</strong> Add your next stop
                        (shape automatically extends to connect)
                      </li>
                      <li>
                        <strong>Continue:</strong> Keep clicking for shape
                        nodes, Shift+click for stops
                      </li>
                      <li>
                        <strong>Ctrl + Z:</strong> Undo the last shape point if
                        you make a mistake
                      </li>
                    </ul>

                    <h5>📍 With "No Shapes" Mode</h5>
                    <ul>
                      <li>
                        <strong>First Click:</strong> Creates your first stop
                      </li>
                      <li>
                        <strong>Shift + Click:</strong> Add additional stops
                        along your route
                      </li>
                      <li>
                        <em
                          >No shape drawing - just stop-to-stop connections</em
                        >
                      </li>
                    </ul>

                    <h5>⚙️ Additional Stop Options</h5>
                    <ul>
                      <li>
                        <strong>Reuse Existing Stops:</strong> Select from
                        previously created stops in your network
                      </li>
                      <li>
                        <strong>Manual Coordinates:</strong> Enter precise
                        lat/lng coordinates for exact placement
                      </li>
                      <li>
                        <strong>Drag Stops:</strong> Click and drag any stop to
                        reposition it
                      </li>
                      <li>
                        <strong>Edit Stop Details:</strong> Click on stop
                        markers to modify names, times, and details
                      </li>
                    </ul>
                  </div>

                  <div class="step-section">
                    <h4>✏️ Editing and Refining Trips</h4>
                    <p>Fine-tune your trip before finishing:</p>
                    <ul>
                      <li>
                        <strong>Copy from Existing Trip:</strong> Use the "Copy
                        from existing trip" dropdown to duplicate stops and
                        shapes from completed trips
                      </li>
                      <li>
                        <strong>Adjust Stop Times:</strong> Click stop markers
                        to set precise arrival/departure times
                      </li>
                      <li>
                        <strong>Drag Stops:</strong> Click and drag stop markers
                        to reposition them on the map
                      </li>
                      <li>
                        <strong>Undo Shape Points:</strong> Press Ctrl+Z (or
                        Cmd+Z on Mac) to undo the last shape point while drawing
                      </li>
                      <li>
                        <strong>Clear Trip:</strong> Use "Clear Trip" button to
                        completely restart (removes all stops and shapes)
                      </li>
                    </ul>
                  </div>

                  <div class="step-section">
                    <h4>💾 Saving, Exporting, and Validating</h4>
                    <p>When your trip is complete:</p>
                    <ul>
                      <li>
                        <strong>Finish Trip:</strong> Click "Finish Trip" to
                        save the trip to your GTFS feed
                      </li>
                      <li>
                        <strong>Save Work:</strong> Use "Save Work" to backup
                        your progress as a JSON file
                      </li>
                      <li>
                        <strong>Load Previous Work:</strong> Resume work from
                        saved JSON files
                      </li>
                      <li>
                        <strong>Preview GTFS:</strong> Open floating preview
                        window to inspect your data
                      </li>
                      <li>
                        <strong>Download GTFS:</strong> Export complete transit
                        feed as a ZIP file
                      </li>
                      <li>
                        <strong>Validate:</strong> Use MobilityData validator to
                        check GTFS compliance
                      </li>
                    </ul>
                  </div>
                </div>

                <div class="instruction-tips">
                  <h4>🔧 Advanced Features</h4>
                  <ul>
                    <li>
                      <strong>Multiple Routes:</strong> Create different routes
                      for various transit lines (Route 1, Route 2, etc.)
                    </li>
                    <li>
                      <strong>Bidirectional Service:</strong> Create trips in
                      both directions using Direction ID 0 and 1
                    </li>
                    <li>
                      <strong>Service Patterns:</strong> Set up different
                      service calendars for weekdays, weekends, and holidays
                    </li>
                    <li>
                      <strong>Copy Trip Patterns:</strong> Use "Copy from
                      existing trip" to duplicate stops and shapes from previous
                      trips
                    </li>
                    <li>
                      <strong>Reuse Existing Stops:</strong> Add existing stops
                      from your network to new trips
                    </li>
                    <li>
                      <strong>Mac Compatibility:</strong> All editing works on
                      Mac - use Cmd instead of Ctrl for shortcuts
                    </li>
                    <li>
                      <strong>Table View Editing:</strong> Switch to Table View
                      for detailed editing of agency info, fares, and schedules
                    </li>
                    <li>
                      <strong>Shape Precision:</strong> Add many shape points to
                      accurately represent vehicle paths around curves and turns
                    </li>
                    <li>
                      <strong>Frequency-Based Service:</strong> Use
                      frequency-based trips for high-frequency routes (every
                      10-15 minutes)
                    </li>
                    <li>
                      <strong>Mixed Service Types:</strong> Combine fixed
                      schedules for some trips with frequency-based service for
                      others
                    </li>
                  </ul>

                  <h4>💡 Best Practices</h4>
                  <ul>
                    <li>
                      <strong>Start Simple:</strong> Begin with one route and a
                      few stops, then expand your network
                    </li>
                    <li>
                      <strong>Consistent Naming:</strong> Use clear, consistent
                      naming for routes and stops
                    </li>
                    <li>
                      <strong>Real-world Accuracy:</strong> Place stops at
                      actual bus stop locations using satellite imagery
                    </li>
                    <li>
                      <strong>Shape Detail:</strong> Draw shapes that follow
                      actual roads and paths
                    </li>
                    <li>
                      <strong>Time Realism:</strong> Set realistic travel times
                      between stops
                    </li>
                    <li>
                      <strong>Regular Saving:</strong> Save your work frequently
                      to prevent data loss
                    </li>
                  </ul>

                  <h4>❓ Troubleshooting</h4>
                  <ul>
                    <li>
                      <strong>Can't see stops:</strong> Make sure you've clicked
                      "Start Creating Trip" first
                    </li>
                    <li>
                      <strong>Shape not appearing:</strong> Check that "No
                      Shapes" toggle is unchecked
                    </li>
                    <li>
                      <strong>Wrong stop location:</strong> Drag the stop marker
                      to reposition it
                    </li>
                    <li>
                      <strong>Need to start over:</strong> Use "Clear Trip" to
                      remove all stops and shapes
                    </li>
                    <li>
                      <strong>GTFS validation errors:</strong> Use the
                      MobilityData validator link for detailed error reports
                    </li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
          </div>
        </section>

        <!-- Preview Section -->
        <section class="content-section" id="preview-section">
          <div class="section-header">
            <h2>Preview GTFS Data</h2>
            <p>View your GTFS data summary and map</p>
          </div>

          <!-- Empty state when no data loaded -->
          <div class="empty-state" id="previewEmptyState">
            <div class="empty-state-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="64" height="64">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </div>
            <h3>No Data to Preview</h3>
            <p>Import an existing GTFS feed or create a new one to see the preview</p>
            <div class="empty-state-actions">
              <button onclick="document.querySelector('[data-section=&quot;import&quot;]').click()" class="empty-state-button">
                Import GTFS
              </button>
              <button onclick="document.querySelector('[data-section=&quot;create&quot;]').click()" class="empty-state-button secondary">
                Create New
              </button>
            </div>
          </div>

          <div class="preview-content" style="display: none">
            <!-- Agency Info Display -->
            <div id="previewAgencyInfo" class="preview-agency-info">
              <div class="feed-info-display">
                <div class="feed-info-grid">
                  <div class="feed-info-item">
                    <span class="feed-info-label">Agency Name:</span>
                    <span id="previewAgencyName" class="feed-info-value">-</span>
                  </div>
                  <div class="feed-info-item">
                    <span class="feed-info-label">feed_info dates:</span>
                    <span id="previewFeedDates" class="feed-info-value">-</span>
                  </div>
                  <div class="feed-info-item">
                    <span class="feed-info-label">Routes:</span>
                    <span id="previewRouteCount" class="feed-info-value">-</span>
                  </div>
                  <div class="feed-info-item">
                    <span class="feed-info-label">fare_media types:</span>
                    <span id="previewFareInfo" class="feed-info-value">-</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Route/Trip Filter for Preview -->
            <div class="preview-route-filter" id="previewRouteFilter">
              <div class="filter-header">
                <h3>Filter Routes & Trips</h3>
              </div>
              <div class="filter-content">
                <div class="filter-section">
                  <label for="previewRouteSearch">Route:</label>
                  <div class="searchable-select" id="previewRouteContainer">
                    <input
                      type="text"
                      id="previewRouteSearch"
                      placeholder="Click to select or type to search routes..."
                      autocomplete="off"
                    />
                    <div class="search-dropdown" id="previewRouteDropdown"></div>
                  </div>
                </div>
                <div class="filter-section">
                  <label for="previewTripSearch">Trip:</label>
                  <div class="searchable-select" id="previewTripContainer">
                    <input
                      type="text"
                      id="previewTripSearch"
                      placeholder="Select route first..."
                      disabled
                      autocomplete="off"
                    />
                    <div class="search-dropdown" id="previewTripDropdown"></div>
                  </div>
                </div>
                <div class="filter-actions">
                  <button id="previewApplyFilter" class="filter-btn">
                    Show on Map
                  </button>
                  <button id="previewClearFilter" class="filter-btn secondary">
                    Clear Filter
                  </button>
                </div>
              </div>
            </div>

            <!-- Preview Map Container -->
            <div
              id="previewMapContainer"
              style="height: 400px; width: 100%; margin: 10px 0"
            ></div>

            <!-- File Statistics -->
            <div class="preview-stats">
              <h4>Data Summary</h4>
              <div
                class="stats-grid"
                style="
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                  gap: 8px;
                "
              >
                <div class="stat-item">
                  <div class="stat-value" id="previewStatsAgencies">0</div>
                  <div class="stat-label">Agencies</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="previewStatsRoutes">0</div>
                  <div class="stat-label">Routes</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="previewStatsTrips">0</div>
                  <div class="stat-label">Trips</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="previewStatsStops">0</div>
                  <div class="stat-label">Stops</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="previewStatsStopTimes">0</div>
                  <div class="stat-label">Stop Times</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value" id="previewStatsServices">0</div>
                  <div class="stat-label">Services</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Instructions Section -->
        <section class="content-section" id="instructions-section">
          <div class="section-header">
            <h2>Instructions</h2>
            <p>Learn how to create and edit GTFS feeds</p>
          </div>
          <div class="instructions-content">
            <div class="instructions-intro">
              <p>
                <strong>Welcome to the GTFS Creator & Editor!</strong> This
                tool helps you build complete transit feeds with routes,
                stops, trips, and schedules, or edit existing GTFS feeds.
                Follow these detailed steps to create or modify professional
                transit data.
              </p>
              <p>
                <a
                  href="https://github.com/google/transit/blob/master/gtfs/spec/en/reference.md"
                  target="_blank"
                  class="gtfs-spec-link"
                  >📖 View Official GTFS Specification</a
                >
              </p>
            </div>

            <div class="instruction-steps">
              <div class="step-section">
                <h3>📁 Step 0: Upload Existing GTFS (Optional)</h3>
                <p>
                  You can start by uploading an existing GTFS feed to
                  visualize and edit it:
                </p>
                <ul>
                  <li>
                    <strong>Upload from local file:</strong> Select a .zip
                    file from your computer
                  </li>
                  <li>
                    <strong>Load from URL:</strong> Enter a direct link to a
                    GTFS .zip file (e.g., https://example.com/gtfs.zip)
                  </li>
                  <li>
                    <strong>Drag & Drop:</strong> Drag a .zip file directly
                    onto the upload section
                  </li>
                </ul>
                <p>
                  <em
                    >💡 Tip: If the URL is blocked by CORS, the tool will
                    automatically use a proxy to download the file.</em
                  >
                </p>
                <p>
                  <em
                    >Skip this step if you want to create a new GTFS feed
                    from scratch.</em
                  >
                </p>
              </div>

              <div class="step-section">
                <h3>🗺️ Step 1: Switch to Map View</h3>
                <p>
                  Click the <strong>"Map View"</strong> button to
                  access the visual route creator. The map view provides an
                  intuitive interface for designing your transit network.
                </p>
                <ul>
                  <li>
                    <strong>Table View:</strong> Use for editing raw GTFS
                    data, stop times, and detailed information
                  </li>
                  <li>
                    <strong>Map View:</strong> Use for visually creating
                    routes, placing stops, and drawing route shapes
                  </li>
                </ul>
              </div>

              <div class="step-section">
                <h3>🚌 Step 2: Create Your First Route</h3>
                <p>
                  Routes represent a single transit line (like "Bus Route 1"
                  or "Blue Line"). In the Route Creator panel:
                </p>
                <ul>
                  <li>
                    <strong>Route Short Name:</strong> Enter a concise
                    identifier (e.g., "1", "A", "Blue")
                  </li>
                  <li>
                    <strong>Route Long Name:</strong> Enter descriptive name
                    (e.g., "Main Street Line", "Downtown Express")
                  </li>
                  <li>
                    <strong>Route Type:</strong> Choose vehicle type - Bus
                    (most common), Tram, Subway, Rail, or Ferry
                  </li>
                  <li>
                    <strong>Route Colors:</strong> Pick brand colors that
                    represent your transit line
                  </li>
                  <li>
                    <strong>Orient Map:</strong> Search for your city/area
                    to center the map on your service area
                  </li>
                  <li>
                    <strong>Contrast Check:</strong> Use the contrast
                    checker to ensure colors meet accessibility standards
                  </li>
                </ul>
                <p>
                  <em
                    >💡 Tip: You can also select existing routes if you're
                    adding trips to established lines.</em
                  >
                </p>
              </div>

              <div class="step-section">
                <h3>🛣️ Step 3: Set Up Your Trip</h3>
                <p>
                  Trips are specific journeys along a route (like "8:00 AM
                  Downtown to Airport"). Configure trip details including
                  headsign, direction, service calendar, timing, and frequencies.
                </p>
                <p>For detailed configuration options, see the sections on
                Service Calendar, Trip Timing, Frequency-Based Service, and Shape Options
                in the create section while building your routes.</p>
              </div>

              <div class="step-section">
                <h3>🎯 Step 4: Create Stops and Route Shapes</h3>
                <p>
                  Click <strong>"Start Creating Trip"</strong> to begin
                  placing stops and drawing your route.
                </p>
                <ul>
                  <li>
                    <strong>First Click:</strong> Creates your first stop
                    and starts the route shape automatically
                  </li>
                  <li>
                    <strong>Normal Clicks:</strong> Add shape nodes to trace
                    the actual path vehicles follow
                  </li>
                  <li>
                    <strong>Shift + Click:</strong> Add your next stop
                    (shape automatically extends to connect)
                  </li>
                  <li>
                    <strong>Ctrl/Cmd + Z:</strong> Undo the last shape point
                  </li>
                </ul>
              </div>

              <div class="step-section">
                <h3>✏️ Step 5: Edit and Refine</h3>
                <p>Fine-tune your trip before finishing:</p>
                <ul>
                  <li>
                    <strong>Copy from Existing Trip:</strong> Duplicate stops and
                    shapes from completed trips
                  </li>
                  <li>
                    <strong>Adjust Stop Times:</strong> Click stop markers
                    to set precise arrival/departure times
                  </li>
                  <li>
                    <strong>Edit Shape Nodes:</strong> Drag visible shape
                    nodes to adjust route path
                  </li>
                  <li>
                    <strong>Clear Trip:</strong> Use "Clear Trip" button to
                    completely restart
                  </li>
                </ul>
              </div>

              <div class="step-section">
                <h3>💾 Step 6: Save, Export, and Validate</h3>
                <p>When your trip is complete:</p>
                <ul>
                  <li>
                    <strong>Finish Trip:</strong> Click "Finish Trip" to
                    save the trip to your GTFS feed
                  </li>
                  <li>
                    <strong>Save Work:</strong> Use "Save Work" to backup
                    your progress as a JSON file
                  </li>
                  <li>
                    <strong>Download GTFS:</strong> Export complete transit
                    feed as a ZIP file
                  </li>
                  <li>
                    <strong>Validate:</strong> Use MobilityData validator to
                    check GTFS compliance
                  </li>
                </ul>
              </div>
            </div>

            <div class="instruction-tips">
              <h3>🔧 Advanced Features</h3>
              <ul>
                <li>Create multiple routes for various transit lines</li>
                <li>Set up bidirectional service using Direction ID 0 and 1</li>
                <li>Configure different service calendars for weekdays, weekends, and holidays</li>
                <li>Use frequency-based service for high-frequency routes</li>
                <li>Reuse existing stops across multiple routes</li>
              </ul>

              <h3>💡 Best Practices</h3>
              <ul>
                <li><strong>Start Simple:</strong> Begin with one route and a few stops</li>
                <li><strong>Consistent Naming:</strong> Use clear, consistent naming conventions</li>
                <li><strong>Real-world Accuracy:</strong> Place stops at actual locations using satellite imagery</li>
                <li><strong>Regular Saving:</strong> Save your work frequently to prevent data loss</li>
              </ul>

              <h3>❓ Troubleshooting</h3>
              <ul>
                <li><strong>Can't see stops:</strong> Make sure you've clicked "Start Creating Trip" first</li>
                <li><strong>Shape not appearing:</strong> Check that "No Shapes" toggle is unchecked</li>
                <li><strong>Wrong stop location:</strong> Drag the stop marker to reposition it</li>
                <li><strong>Need to start over:</strong> Use "Clear Trip" to remove all stops and shapes</li>
              </ul>
            </div>
          </div>
        </section>
      </main>
    </div>

      <!-- Floating Preview Window -->
      <div class="floating-preview-window" id="floatingPreviewWindow" style="display: none;">
        <div class="floating-window-header">
          <div class="drag-handle">
            <span class="window-title">🗺️ GTFS Preview</span>
          </div>
          <div class="window-controls">
            <button class="collapse-btn" id="collapsePreview" title="Collapse Preview">−</button>
            <button class="close-btn" id="closePreview" title="Close Preview">×</button>
          </div>
        </div>
        <div class="floating-window-content" id="floatingPreviewContent">
          <!-- Preview content will be populated by JavaScript -->
          <div id="previewContentInner">
            <div class="preview-stats-small">
              <div class="stat-item">
                <span class="stat-label">Routes:</span>
                <span id="floatingPreviewRoutes" class="stat-value">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Stops:</span>
                <span id="floatingPreviewStops" class="stat-value">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Trips:</span>
                <span id="floatingPreviewTrips" class="stat-value">0</span>
              </div>
            </div>

            <!-- Route/Trip Filter for Preview -->
            <div class="preview-filter" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
              <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600;">Filter by Route:</label>
                  <select id="previewRouteSelect" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">All Routes</option>
                  </select>
                </div>
                <div style="flex: 1;">
                  <label style="display: block; margin-bottom: 5px; font-size: 12px; font-weight: 600;">Filter by Trip:</label>
                  <select id="previewTripSelect" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" disabled>
                    <option value="">Select route first</option>
                  </select>
                </div>
                <button id="previewApplyFilterBtn" style="padding: 6px 16px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">Apply</button>
              </div>
            </div>

            <div id="floatingPreviewMapContainer" style="height: 400px; width: 100%; margin-top: 10px;"></div>
          </div>
        </div>
      </div>

      <!-- Floating Export/Save Window -->
      <div class="floating-export-window" id="floatingExportWindow" style="display: none;">
        <div class="floating-window-header">
          <div class="drag-handle">
            <span class="window-title">💾 Export & Save</span>
          </div>
          <div class="window-controls">
            <button class="close-btn" id="closeExport" title="Close Export">×</button>
          </div>
        </div>
        <div class="floating-window-content" id="floatingExportContent">
          <div class="export-actions">
            <div class="action-group">
              <h3>Save Progress</h3>
              <p class="action-description">Save your work as a JSON file to continue later</p>
              <button id="saveWorkBtn" class="save-btn action-button">Save Work</button>
            </div>

            <div class="action-group">
              <h3>Download GTFS</h3>
              <p class="action-description">Export your complete GTFS feed as a ZIP file</p>
              <button id="downloadBtn" class="action-button">Download GTFS</button>
            </div>

            <div class="action-group">
              <h3>Validate</h3>
              <p class="action-description">Check your GTFS feed for errors and warnings</p>
              <a
                href="https://gtfs-validator.mobilitydata.org/"
                target="_blank"
                class="validate-link action-button"
                >Validate with MobilityData</a
              >
            </div>

            <div class="action-group">
              <h3>Reset</h3>
              <p class="action-description">Clear all data and start fresh</p>
              <button id="resetPageBtn" class="action-button secondary-button">
                Reset Page
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        id="validationResults"
        class="validation-results"
        style="display: none"
      ></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="gtfs-spec.js"></script>
    <script src="gtfs-parser.js"></script>
    <script src="gtfs-editor.js"></script>
    <script src="map-editor.js"></script>
    <script src="app.js"></script>
  </body>
</html>
