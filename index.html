<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Static Data GTFS Editor / Creator</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1 id="mainTitle">Static Data GTFS Editor / Creator</h1>
        <p>Create and edit GTFS files</p>
      </header>

      <div class="upload-section">
        <h2>Upload GTFS .zip to visualize and edit</h2>
        <input type="file" id="gtfsUpload" accept=".zip" />
        <button id="uploadBtn">Upload GTFS</button>
        <div id="uploadStatus"></div>
        <div id="agencyInfo" style="display: none">
          <div id="feedInfoDisplay" class="feed-info-display">
            <div class="feed-info-grid">
              <div class="feed-info-item">
                <span class="feed-info-label">Agency Name:</span>
                <span id="agencyName" class="feed-info-value">-</span>
              </div>
              <div class="feed-info-item">
                <span class="feed-info-label">feed_info dates:</span>
                <span id="feedDates" class="feed-info-value">-</span>
              </div>
              <div class="feed-info-item">
                <span class="feed-info-label">Routes:</span>
                <span id="routeCount" class="feed-info-value">-</span>
              </div>
              <div class="feed-info-item">
                <span class="feed-info-label">fare_media types:</span>
                <span id="fareInfo" class="feed-info-value">-</span>
              </div>
            </div>
          </div>
          <div
            id="feedExpirationWarning"
            class="feed-expiration-warning"
            style="display: none"
          >
            <span class="warning-icon">⚠️</span>
            <span class="warning-text">This feed expires soon!</span>
          </div>
          <button id="agencyWebsiteBtn" class="agency-website-btn">
            Visit Agency Website
          </button>
        </div>
      </div>

      <div class="editor-section" id="editorSection" style="display: none">
        <h2 id="editorTitle" style="display: none; margin-bottom: 20px">
          Creating New GTFS
        </h2>


        <div class="editor-header">
          <div class="file-tabs" id="fileTabs"></div>
          <div class="view-toggle">
            <button id="tableViewBtn" class="view-btn active">
              Table View
            </button>
            <button id="mapViewBtn" class="view-btn">Map View</button>
          </div>
        </div>

        <div class="editor-content">
          <div class="table-view" id="tableView">
            <div class="table-container" id="tableContainer"></div>
          </div>

          <div class="map-view" id="mapView" style="display: none">
            <div class="map-toolbar">
              <!-- Route/Trip Filter Dropdown for Uploaded GTFS -->
              <div
                class="route-trip-filter"
                id="routeTripFilter"
                style="display: none"
              >
                <div class="filter-header" id="filterHeader">
                  <h3>Filter Routes & Trips</h3>
                  <button
                    class="collapse-filter-btn"
                    id="collapseFilterBtn"
                    title="Collapse/Expand Filter"
                  >
                    −
                  </button>
                </div>
                <div class="filter-content" id="filterContent">
                  <div class="filter-section">
                    <label for="routeFilterSearch">Route:</label>
                    <div class="searchable-select" id="routeSearchContainer">
                      <input
                        type="text"
                        id="routeFilterSearch"
                        placeholder="Click to select or type to search routes..."
                        autocomplete="off"
                      />
                      <div
                        class="search-dropdown"
                        id="routeSearchDropdown"
                      ></div>
                    </div>
                  </div>

                  <div class="filter-section">
                    <label for="tripFilterSearch">Trip:</label>
                    <div class="searchable-select" id="tripSearchContainer">
                      <input
                        type="text"
                        id="tripFilterSearch"
                        placeholder="Select route first..."
                        disabled
                        autocomplete="off"
                      />
                      <div
                        class="search-dropdown"
                        id="tripSearchDropdown"
                      ></div>
                    </div>
                  </div>

                  <div class="filter-actions">
                    <button id="applyFilterBtn" class="filter-btn">
                      Show on Map
                    </button>
                    <button id="clearFilterBtn" class="filter-btn secondary">
                      Clear Filter
                    </button>
                  </div>
                </div>
              </div>

              <div class="route-creator">
                <div class="route-creator-header" id="routeCreatorHeader">
                  <h3>Route & Trip Creator</h3>
                  <button
                    class="collapse-creator-btn"
                    id="collapseCreatorBtn"
                    title="Collapse/Expand Creator"
                  >
                    −
                  </button>
                </div>
                <div class="route-creator-content" id="routeCreatorContent">
                  <!-- Route Creation Section -->
                  <div class="creator-section" id="routeSection">
                    <h4>1. Create Route</h4>
                    <div class="route-inputs">
                      <div class="input-group">
                        <label for="routeNameInput">Route Short Name:</label>
                        <input
                          type="text"
                          id="routeNameInput"
                          placeholder="1"
                        />
                      </div>
                      <div class="input-group">
                        <label for="routeLongNameInput">Route Long Name:</label>
                        <input
                          type="text"
                          id="routeLongNameInput"
                          placeholder="Main Street Line"
                        />
                      </div>
                      <div class="input-group">
                        <label for="routeTypeSelect">Type:</label>
                        <select id="routeTypeSelect">
                          <option value="3">Bus</option>
                          <option value="0">Tram/Light Rail</option>
                          <option value="1">Subway/Metro</option>
                          <option value="2">Rail</option>
                          <option value="4">Ferry</option>
                        </select>
                      </div>
                      <div class="input-group">
                        <label for="routeColorInput">Route Color:</label>
                        <div class="color-input-group">
                          <input
                            type="color"
                            id="routeColorInput"
                            value="#4caf50"
                          />
                          <input
                            type="text"
                            id="routeColorHex"
                            value="#4caf50"
                            placeholder="#RRGGBB"
                            maxlength="7"
                          />
                        </div>
                      </div>
                      <div class="input-group">
                        <label for="routeTextColorInput">Text Color:</label>
                        <div class="color-input-group">
                          <input
                            type="color"
                            id="routeTextColorInput"
                            value="#ffffff"
                          />
                          <input
                            type="text"
                            id="routeTextColorHex"
                            value="#ffffff"
                            placeholder="#RRGGBB"
                            maxlength="7"
                          />
                        </div>
                      </div>
                      <div
                        style="
                          grid-column: span 3;
                          text-align: center;
                          margin-top: 10px;
                        "
                      >
                        <button
                          type="button"
                          class="contrast-check-btn"
                          onclick="window.open('https://contrastchecker.com/', '_blank')"
                        >
                          Check Contrast
                        </button>
                      </div>
                    </div>
                    <div class="route-buttons">
                      <button id="createRouteBtn">Create Route</button>
                      <button id="selectExistingRouteBtn">
                        Use Existing Route
                      </button>
                    </div>
                    <div class="input-group" style="margin-top: 15px">
                      <label for="locationSearchInput">Orient Map:</label>
                      <input
                        type="text"
                        id="locationSearchInput"
                        placeholder="Search city or address to center map..."
                      />
                    </div>
                    <button id="searchLocationBtn" type="button">
                      Center Map
                    </button>
                  </div>

                  <!-- Route Selection Section -->
                  <div
                    class="creator-section"
                    id="routeSelectSection"
                    style="display: none"
                  >
                    <h4>Select Existing Route</h4>
                    <select id="existingRouteSelect">
                      <option value="">Choose a route...</option>
                    </select>
                    <button id="selectRouteBtn">Select Route</button>
                    <button id="cancelSelectBtn">Cancel</button>
                  </div>

                  <!-- Trip Creation Section -->
                  <div
                    class="creator-section"
                    id="tripSection"
                    style="display: none"
                  >
                    <h4>2. Create Trip <span id="currentRouteIndicator" style="color: #666; font-weight: normal; font-size: 0.9em;"></span></h4>
                    
                    <!-- Trip Creation Method -->
                    <div class="trip-creation-method">
                      <div class="input-group">
                        <label for="tripCreationMethodSelect">Trip Creation Method:</label>
                        <select id="tripCreationMethodSelect">
                          <option value="scratch">Create from scratch</option>
                          <option value="copy">Copy from existing trip</option>
                        </select>
                      </div>
                    </div>

                    <!-- Copy Trip Selection -->
                    <div class="copy-trip-section" id="copyTripSection" style="display: none;">
                      <div class="input-group">
                        <label for="copyFromTripSelect">Select Trip to Copy:</label>
                        <select id="copyFromTripSelect">
                          <option value="">Choose an existing trip...</option>
                        </select>
                      </div>
                      <button id="loadTripDataBtn" class="secondary-btn" disabled>
                        Load Trip Data
                      </button>
                      <p class="copy-trip-description">This will load all trip details (headsign, direction, stops, shape, timing) which you can then modify and save as a new trip.</p>
                    </div>

                    <div class="trip-inputs">
                      <div class="input-group">
                        <label for="tripHeadsignInput">Trip Headsign:</label>
                        <input
                          type="text"
                          id="tripHeadsignInput"
                          placeholder="Downtown"
                        />
                      </div>
                      <div class="input-group">
                        <label for="directionSelect">Direction ID:</label>
                        <select id="directionSelect">
                          <option value="0">0</option>
                          <option value="1">1</option>
                        </select>
                      </div>
                      <div class="input-group">
                        <label for="tripShortNameInput">Trip Short Name:</label>
                        <input
                          type="text"
                          id="tripShortNameInput"
                          placeholder="Optional"
                        />
                      </div>
                    </div>

                    <div class="calendar-section">
                      <h5>Service Calendar</h5>
                      <div class="calendar-method">
                        <label for="calendarMethodSelect"
                          >Calendar Method:</label
                        >
                        <select id="calendarMethodSelect" required>
                          <option value="">Select service option...</option>
                          <option value="existing">Use existing service</option>
                          <option value="new">Create new service</option>
                          <option value="none">
                            No Service (trips will not run)
                          </option>
                        </select>
                      </div>

                      <div class="calendar-inputs" id="existingCalendarInputs">
                        <div class="input-group">
                          <label for="existingServiceSelect"
                            >Existing Service:</label
                          >
                          <select id="existingServiceSelect">
                            <option value="">Choose a service...</option>
                          </select>
                        </div>
                      </div>

                      <div
                        class="calendar-inputs"
                        id="newCalendarInputs"
                        style="display: none"
                      >
                        <div class="input-group">
                          <label for="serviceNameInput">Service Name:</label>
                          <input
                            type="text"
                            id="serviceNameInput"
                            placeholder="weekday_service"
                          />
                        </div>
                        <div class="input-group">
                          <label>Days of Operation:</label>
                          <div class="days-checkboxes">
                            <label>
                              Monday
                              <input type="checkbox" id="mondayCheck" checked />
                            </label>
                            <label>
                              Tuesday
                              <input
                                type="checkbox"
                                id="tuesdayCheck"
                                checked
                              />
                            </label>
                            <label>
                              Wednesday
                              <input
                                type="checkbox"
                                id="wednesdayCheck"
                                checked
                              />
                            </label>
                            <label>
                              Thursday
                              <input
                                type="checkbox"
                                id="thursdayCheck"
                                checked
                              />
                            </label>
                            <label>
                              Friday
                              <input type="checkbox" id="fridayCheck" checked />
                            </label>
                            <label>
                              Saturday
                              <input type="checkbox" id="saturdayCheck" />
                            </label>
                            <label>
                              Sunday
                              <input type="checkbox" id="sundayCheck" />
                            </label>
                          </div>
                        </div>
                        <div class="date-inputs">
                          <div class="input-group-inline">
                            <label for="startDateInput">Start Date:</label>
                            <input type="date" id="startDateInput" />
                          </div>
                          <div class="input-group-inline">
                            <label for="endDateInput">End Date:</label>
                            <input type="date" id="endDateInput" />
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="timing-section">
                      <h5>Trip Timing</h5>
                      <div class="timing-method">
                        <label for="timingMethodSelect"
                          >Timing Between Stops:</label
                        >
                        <select id="timingMethodSelect">
                          <option value="auto">
                            Auto-calculate with intervals (automatically sets
                            stop_times between stops)
                          </option>
                          <option value="manual" selected>Set time for each stop</option>
                        </select>
                      </div>

                      <div class="timing-inputs" id="autoTimingInputs" style="display: none">
                        <div class="input-group-inline">
                          <label for="tripStartTimeInput">Start Time:</label>
                          <input
                            type="time"
                            id="tripStartTimeInput"
                            value="08:00"
                          />
                        </div>
                        <div class="input-group-inline">
                          <label for="defaultStopIntervalInput"
                            >Interval (min):</label
                          >
                          <input
                            type="number"
                            id="defaultStopIntervalInput"
                            value="2"
                            min="1"
                            max="60"
                          />
                        </div>
                      </div>

                      <div
                        class="timing-inputs"
                        id="manualTimingInputs"
                      >
                        <p class="timing-note">
                          You'll set arrival/departure times when adding each
                          stop
                        </p>
                      </div>
                    </div>

                    <div class="frequencies-section">
                      <h5>Frequency-Based Service</h5>
                      <div class="frequency-toggle">
                        <label for="useFrequenciesToggle" class="toggle-label">
                          <input type="checkbox" id="useFrequenciesToggle" />
                          <span class="toggle-text">Use frequency-based service</span>
                        </label>
                        <p class="toggle-description">Enable to create headway-based trips instead of specific stop times</p>
                      </div>

                      <div class="frequency-inputs" id="frequencyInputs" style="display: none;">
                        <p class="frequency-note">
                          <strong>Note:</strong> When using frequencies, only the first trip needs stop times as a template.
                          Additional trips are generated automatically based on headway intervals.
                        </p>

                        <div class="frequency-periods">
                          <h6>Service Periods</h6>
                          <div class="frequency-period-list" id="frequencyPeriodList">
                            <div class="frequency-empty">No frequency periods defined</div>
                          </div>

                          <div class="add-frequency-period">
                            <div class="frequency-period-inputs">
                              <div class="input-group-inline">
                                <label for="frequencyStartInput">Start Time:</label>
                                <input type="time" id="frequencyStartInput" value="06:00" />
                              </div>
                              <div class="input-group-inline">
                                <label for="frequencyEndInput">End Time:</label>
                                <input type="time" id="frequencyEndInput" value="22:00" />
                              </div>
                              <div class="input-group-inline">
                                <label for="headwaySecsInput">Headway (minutes):</label>
                                <input type="number" id="headwaySecsInput" value="15" min="1" max="120" />
                              </div>
                              <div class="input-group-inline">
                                <label for="exactTimesSelect">Timing:</label>
                                <select id="exactTimesSelect">
                                  <option value="0">Exact times</option>
                                  <option value="1">Approximate times</option>
                                </select>
                              </div>
                            </div>
                            <button id="addFrequencyPeriodBtn" class="add-frequency-btn">Add Period</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="trip-buttons">
                      <button id="startTripBtn">Start Creating Trip</button>
                      <button id="finishTripBtn" disabled>Finish Trip</button>
                      <button id="clearTripBtn">Clear Trip</button>
                      <button id="backToRouteBtn">Back to Route</button>
                    </div>
                  </div>
                </div>
              </div>
              <div id="mapContainer">
                <div id="mapLoading" class="map-loading">
                  <div class="loading-spinner"></div>
                  <p>Loading map...</p>
                </div>
              </div>

              <!-- Map Route Info Panel -->
              <div
                class="floating-route-info"
                id="floatingRouteInfo"
                style="display: none"
              >
                <div class="floating-window-header">
                  <div class="drag-handle">
                    <span class="window-title">Working on Route</span>
                  </div>
                  <div class="window-controls">
                    <button
                      class="collapse-btn"
                      id="collapseRouteInfo"
                      title="Collapse Panel"
                    >
                      −
                    </button>
                    <button
                      class="close-btn"
                      id="closeRouteInfo"
                      title="Hide Panel"
                    >
                      ×
                    </button>
                  </div>
                </div>
                <div class="floating-window-content" id="floatingWindowContent">
                  <div class="current-route-info">
                    <div class="route-summary">
                      <h4><span id="currentRouteName">-</span></h4>
                      <p>
                        <strong>Type:</strong>
                        <span id="currentRouteType">-</span> |
                        <strong>ID:</strong> <span id="currentRouteId">-</span>
                      </p>
                    </div>
                  </div>

                  <div class="current-trip-info">
                    <h5>Current Trip</h5>
                    <div class="trip-stats">
                      <div class="stat-item">
                        <strong>Headsign:</strong>
                        <span id="currentHeadsign">-</span>
                      </div>
                      <div class="stat-item">
                        <strong>Direction:</strong>
                        <span id="currentDirection">-</span>
                      </div>
                      <div class="stat-item">
                        <strong>Stops:</strong> <span id="stopCount">0</span>
                      </div>
                      <div class="stat-item">
                        <strong>Distance:</strong>
                        <span id="routeDistance">0 km</span>
                      </div>
                    </div>
                  </div>

                  <!-- Shape Options Section -->
                  <div class="shape-options-section">
                    <h6>Shape Options</h6>
                    <div class="shape-toggle">
                      <label for="noShapesToggle" class="toggle-label">
                        <input type="checkbox" id="noShapesToggle" />
                        <span class="toggle-text">No Shapes (stops only)</span>
                      </label>
                      <p class="toggle-description">Disable route shape drawing and create stops only</p>
                    </div>
                  </div>


                  <div class="stops-list-section">
                    <h5
                      style="
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                      "
                      id="stopsListToggle"
                    >
                      Trip Stops
                      <span id="stopsToggleIcon">▼</span>
                    </h5>
                    <div id="stopsListContainer" class="stops-list">
                      <div id="stopsListEmpty" class="stops-empty">
                        No stops added yet
                      </div>
                      <ul id="stopsList" style="display: none"></ul>
                    </div>
                  </div>

                  <!-- Existing Stops Section -->
                  <div
                    class="existing-stops-section"
                    id="existingStopsSection"
                    style="display: none"
                  >
                    <h6>Reuse Existing Stops</h6>
                    <div class="existing-stops-selector">
                      <div class="searchable-select" id="existingStopsContainer">
                        <input
                          type="text"
                          id="existingStopsSearch"
                          placeholder="Click to select or type to search stops..."
                          autocomplete="off"
                        />
                        <div
                          class="search-dropdown"
                          id="existingStopsDropdown"
                        ></div>
                      </div>
                      <div class="existing-stops-actions">
                        <button id="addExistingStopBtn" class="add-stop-btn" disabled>
                          Add Selected Stop
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Existing Trips Section -->
                  <div
                    class="existing-trips-section"
                    id="existingTripsSection"
                    style="display: none"
                  >
                    <h6>Edit Existing Trips</h6>
                    <div class="existing-trips-list" id="existingTripsList">
                      <div class="trips-empty" id="tripsListEmpty">
                        No trips created yet for this route
                      </div>
                    </div>
                  </div>

                  <div class="stop-input-section">
                    <h6>Add Stop by Coordinates</h6>
                    <div class="coord-inputs">
                      <div class="coord-group">
                        <label for="latInput">Lat:</label>
                        <input
                          type="number"
                          id="latInput"
                          step="0.000001"
                          placeholder="40.7128"
                        />
                      </div>
                      <div class="coord-group">
                        <label for="lngInput">Lng:</label>
                        <input
                          type="number"
                          id="lngInput"
                          step="0.000001"
                          placeholder="-74.0060"
                        />
                      </div>
                    </div>
                    <div
                      class="coord-time-inputs"
                      id="coordTimeInputs"
                    >
                      <div class="coord-group">
                        <label for="coordArrivalInput">Arrival:</label>
                        <input type="time" id="coordArrivalInput" />
                      </div>
                      <div class="coord-group">
                        <label for="coordDepartureInput">Departure:</label>
                        <input type="time" id="coordDepartureInput" />
                      </div>
                    </div>
                    <button
                      id="addStopByCoordBtn"
                      type="button"
                      class="add-stop-btn"
                    >
                      Add Stop
                    </button>
                  </div>
                </div>
                <!-- Close route-creator-content -->
              </div>
            </div>

            <!-- Floating Instructions Panel -->
            <div
              class="floating-instructions"
              id="floatingInstructions"
              style="display: none"
            >
              <div class="floating-window-header">
                <div class="drag-handle">
                  <span class="window-title">📋 Instructions</span>
                </div>
                <div class="window-controls">
                  <button
                    class="collapse-btn"
                    id="collapseInstructions"
                    title="Collapse Panel"
                  >
                    +
                  </button>
                  <button
                    class="close-btn"
                    id="closeInstructions"
                    title="Hide Panel"
                  >
                    ×
                  </button>
                </div>
              </div>
              <div class="floating-window-content collapsed" id="instructionsWindowContent">
                <div class="instructions-intro">
                  <p><strong>Welcome to the GTFS Creator!</strong> This tool helps you build complete transit feeds with routes, stops, trips, and schedules. Follow these detailed steps to create professional transit data.</p>
                  <p><a href="https://github.com/google/transit/blob/master/gtfs/spec/en/reference.md" target="_blank" class="gtfs-spec-link">📖 View Official GTFS Specification</a></p>
                </div>

                <div class="instruction-steps">
                  <div class="step-section">
                    <h4>🗺️ Step 1: Switch to Map View</h4>
                    <p>Click the <strong>"Map View"</strong> button above to access the visual route creator. The map view provides an intuitive interface for designing your transit network.</p>
                    <ul>
                      <li><strong>Table View:</strong> Use for editing raw GTFS data, stop times, and detailed information</li>
                      <li><strong>Map View:</strong> Use for visually creating routes, placing stops, and drawing route shapes</li>
                    </ul>
                  </div>
                  
                  <div class="step-section">
                    <h4>🚌 Step 2: Create Your First Route</h4>
                    <p>Routes represent a single transit line (like "Bus Route 1" or "Blue Line"). In the Route Creator panel:</p>
                    <ul>
                      <li><strong>Route Short Name:</strong> Enter a concise identifier (e.g., "1", "A", "Blue")</li>
                      <li><strong>Route Long Name:</strong> Enter descriptive name (e.g., "Main Street Line", "Downtown Express")</li>
                      <li><strong>Route Type:</strong> Choose vehicle type - Bus (most common), Tram, Subway, Rail, or Ferry</li>
                      <li><strong>Route Colors:</strong> Pick brand colors that represent your transit line</li>
                      <li><strong>Orient Map:</strong> Search for your city/area to center the map on your service area</li>
                      <li><strong>Contrast Check:</strong> Use the contrast checker to ensure colors meet accessibility standards</li>
                    </ul>
                    <p><em>💡 Tip: You can also select existing routes if you're adding trips to established lines.</em></p>
                  </div>
                  
                  <div class="step-section">
                    <h4>🛣️ Step 3: Set Up Your Trip</h4>
                    <p>Trips are specific journeys along a route (like "8:00 AM Downtown to Airport"). Configure trip details:</p>
                    <ul>
                      <li><strong>Trip Headsign:</strong> Destination shown to passengers (e.g., "Downtown", "Airport", "City Center")</li>
                      <li><strong>Direction ID:</strong> Use 0 for outbound, 1 for return journey (helps organize opposite directions)</li>
                      <li><strong>Trip Short Name:</strong> Optional identifier for internal use</li>
                    </ul>
                    
                    <h5>📅 Service Calendar</h5>
                    <ul>
                      <li><strong>Use Existing Service:</strong> Select pre-configured service patterns</li>
                      <li><strong>Create New Service:</strong> Define custom schedule with specific days and date ranges</li>
                      <li><strong>Days Selection:</strong> Choose which days of the week this trip operates</li>
                    </ul>
                    
                    <h5>⏰ Trip Timing</h5>
                    <ul>
                      <li><strong>Set time for each stop (Recommended):</strong> Manually set arrival/departure times for precision</li>
                      <li><strong>Auto-calculate:</strong> Generate times based on start time and interval between stops</li>
                    </ul>

                    <h5>🕐 Frequency-Based Service</h5>
                    <ul>
                      <li><strong>Frequency Toggle:</strong> Enable to create headway-based trips instead of fixed schedules</li>
                      <li><strong>Service Periods:</strong> Define different headways for different times of day (e.g., peak vs off-peak)</li>
                      <li><strong>Headway Intervals:</strong> Set how often vehicles run (e.g., every 15 minutes)</li>
                      <li><strong>Exact vs Approximate:</strong> Choose whether departure times are exact or approximate</li>
                      <li><strong>Template Trip:</strong> Only the first trip needs stop times - frequencies automatically generate additional trips</li>
                    </ul>

                    <h5>🎨 Shape Options</h5>
                    <ul>
                      <li><strong>Shapes Enabled (Default):</strong> Creates detailed route paths showing actual vehicle movement</li>
                      <li><strong>"No Shapes" Toggle:</strong> Check this to create only stops without detailed route paths</li>
                    </ul>
                  </div>
                  
                  <div class="step-section">
                    <h4>🎯 Step 4: Create Stops and Route Shapes</h4>
                    <p>Click <strong>"Start Creating Trip"</strong> to begin placing stops and drawing your route. The workflow differs based on your shape settings:</p>
                    
                    <h5>📍 With Shapes Enabled (Recommended)</h5>
                    <ul>
                      <li><strong>First Click:</strong> Creates your first stop AND starts the route shape automatically</li>
                      <li><strong>Normal Clicks:</strong> Add shape nodes to trace the actual path vehicles follow (roads, turns, etc.)</li>
                      <li><strong>Shift + Click:</strong> Add your next stop (shape automatically extends to connect)</li>
                      <li><strong>Continue:</strong> Keep clicking for shape nodes, Shift+click for stops</li>
                      <li><strong>Ctrl + Z:</strong> Undo the last shape point if you make a mistake</li>
                    </ul>
                    
                    <h5>📍 With "No Shapes" Mode</h5>
                    <ul>
                      <li><strong>First Click:</strong> Creates your first stop</li>
                      <li><strong>Shift + Click:</strong> Add additional stops along your route</li>
                      <li><em>No shape drawing - just stop-to-stop connections</em></li>
                    </ul>
                    
                    <h5>⚙️ Additional Stop Options</h5>
                    <ul>
                      <li><strong>Reuse Existing Stops:</strong> Select from previously created stops in your network</li>
                      <li><strong>Manual Coordinates:</strong> Enter precise lat/lng coordinates for exact placement</li>
                      <li><strong>Drag Stops:</strong> Click and drag any stop to reposition it</li>
                      <li><strong>Edit Stop Details:</strong> Click on stop markers to modify names, times, and details</li>
                    </ul>
                  </div>
                  
                  <div class="step-section">
                    <h4>✏️ Step 5: Edit and Refine</h4>
                    <p>Fine-tune your trip before finishing:</p>
                    <ul>
                      <li><strong>Copy from Existing Trip:</strong> Use the "Copy from existing trip" dropdown to duplicate stops and shapes from completed trips</li>
                      <li><strong>Adjust Stop Times:</strong> Click stop markers to set precise arrival/departure times</li>
                      <li><strong>Edit Shape Nodes:</strong> Drag visible shape nodes to adjust route path, double-click nodes to delete them</li>
                      <li><strong>Add Shape Nodes:</strong> Click directly on shape lines to add new nodes at that position</li>
                      <li><strong>Delete Shape Nodes:</strong> Double-click on white shape node handles to remove them</li>
                      <li><strong>Undo Shape Points:</strong> Press Ctrl+Z (or Cmd+Z on Mac) to undo the last shape point</li>
                      <li><strong>Clear Trip:</strong> Use "Clear Trip" button to completely restart (removes all stops and shapes)</li>
                    </ul>
                  </div>
                  
                  <div class="step-section">
                    <h4>💾 Step 6: Save, Export, and Validate</h4>
                    <p>When your trip is complete:</p>
                    <ul>
                      <li><strong>Finish Trip:</strong> Click "Finish Trip" to save the trip to your GTFS feed</li>
                      <li><strong>Save Work:</strong> Use "Save Work" to backup your progress as a JSON file</li>
                      <li><strong>Load Previous Work:</strong> Resume work from saved JSON files</li>
                      <li><strong>Preview GTFS:</strong> Open floating preview window to inspect your data</li>
                      <li><strong>Download GTFS:</strong> Export complete transit feed as a ZIP file</li>
                      <li><strong>Validate:</strong> Use MobilityData validator to check GTFS compliance</li>
                    </ul>
                  </div>
                </div>
                
                <div class="instruction-tips">
                  <h4>🔧 Advanced Features</h4>
                  <ul>
                    <li><strong>Multiple Routes:</strong> Create different routes for various transit lines (Route 1, Route 2, etc.)</li>
                    <li><strong>Bidirectional Service:</strong> Create trips in both directions using Direction ID 0 and 1</li>
                    <li><strong>Service Patterns:</strong> Set up different service calendars for weekdays, weekends, and holidays</li>
                    <li><strong>Copy Trip Patterns:</strong> Use "Copy from existing trip" to duplicate stops and shapes from previous trips</li>
                    <li><strong>Reuse Existing Stops:</strong> Add existing stops from your network to new trips</li>
                    <li><strong>Mac Compatibility:</strong> All editing works on Mac - use Cmd instead of Ctrl for shortcuts</li>
                    <li><strong>Table View Editing:</strong> Switch to Table View for detailed editing of agency info, fares, and schedules</li>
                    <li><strong>Shape Precision:</strong> Add many shape points to accurately represent vehicle paths around curves and turns</li>
                    <li><strong>Frequency-Based Service:</strong> Use frequency-based trips for high-frequency routes (every 10-15 minutes)</li>
                    <li><strong>Mixed Service Types:</strong> Combine fixed schedules for some trips with frequency-based service for others</li>
                  </ul>
                  
                  <h4>💡 Best Practices</h4>
                  <ul>
                    <li><strong>Start Simple:</strong> Begin with one route and a few stops, then expand your network</li>
                    <li><strong>Consistent Naming:</strong> Use clear, consistent naming for routes and stops</li>
                    <li><strong>Real-world Accuracy:</strong> Place stops at actual bus stop locations using satellite imagery</li>
                    <li><strong>Shape Detail:</strong> Draw shapes that follow actual roads and paths</li>
                    <li><strong>Time Realism:</strong> Set realistic travel times between stops</li>
                    <li><strong>Regular Saving:</strong> Save your work frequently to prevent data loss</li>
                  </ul>
                  
                  <h4>❓ Troubleshooting</h4>
                  <ul>
                    <li><strong>Can't see stops:</strong> Make sure you've clicked "Start Creating Trip" first</li>
                    <li><strong>Shape not appearing:</strong> Check that "No Shapes" toggle is unchecked</li>
                    <li><strong>Wrong stop location:</strong> Drag the stop marker to reposition it</li>
                    <li><strong>Need to start over:</strong> Use "Clear Trip" to remove all stops and shapes</li>
                    <li><strong>GTFS validation errors:</strong> Use the MobilityData validator link for detailed error reports</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="actions">
          <div class="table-actions">
            <button id="addRowBtn">Add Row</button>
            <button id="deleteRowBtn">Delete Selected</button>
          </div>

          <div class="gtfs-actions">
            <div class="gtfs-export-actions">
              <button id="saveWorkBtn" class="save-btn">💾 Save Work</button>
              <button id="previewBtn" class="preview-btn">👁️ Preview GTFS</button>
              <button id="downloadBtn">Download GTFS</button>
              <button id="resetPageBtn" style="display: none">Reset Page</button>
              <a
                href="https://gtfs-validator.mobilitydata.org/"
                target="_blank"
                class="validate-link"
                >Validate with MobilityData</a
              >
            </div>
          </div>
        </div>
      </div>

      <div class="create-section">
        <h2>Create New GTFS Feed</h2>
        <div class="create-actions">
          <button id="createNewBtn">Create New Feed</button>
          <button id="loadWorkBtn" class="load-btn">Load Previous Work</button>
          <input type="file" id="loadWorkFile" accept=".json" style="display: none;">
        </div>
      </div>

      <div
        id="validationResults"
        class="validation-results"
        style="display: none"
      ></div>

      <!-- Floating GTFS Preview Window -->
      <div
        class="floating-preview-window"
        id="floatingPreviewWindow"
        style="display: none"
      >
        <div class="floating-window-header">
          <div class="drag-handle">
            <span class="window-title">📊 GTFS Data Preview</span>
          </div>
          <div class="window-controls">
            <button
              class="collapse-btn"
              id="collapsePreview"
              title="Collapse Panel"
            >
              −
            </button>
            <button
              class="close-btn"
              id="closePreview"
              title="Close Preview"
            >
              ×
            </button>
          </div>
        </div>
        <div class="floating-window-content" id="previewWindowContent">
          <!-- Agency Info Display (similar to upload section) -->
          <div id="previewAgencyInfo" class="preview-agency-info">
            <div class="feed-info-display">
              <div class="feed-info-grid">
                <div class="feed-info-item">
                  <span class="feed-info-label">Agency Name:</span>
                  <span id="previewAgencyName" class="feed-info-value">-</span>
                </div>
                <div class="feed-info-item">
                  <span class="feed-info-label">feed_info dates:</span>
                  <span id="previewFeedDates" class="feed-info-value">-</span>
                </div>
                <div class="feed-info-item">
                  <span class="feed-info-label">Routes:</span>
                  <span id="previewRouteCount" class="feed-info-value">-</span>
                </div>
                <div class="feed-info-item">
                  <span class="feed-info-label">fare_media types:</span>
                  <span id="previewFareInfo" class="feed-info-value">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Route/Trip Filter for Preview -->
          <div class="preview-route-filter" id="previewRouteFilter">
            <div class="filter-header">
              <h3>Filter Routes & Trips</h3>
            </div>
            <div class="filter-content">
              <div class="filter-section">
                <label for="previewRouteSearch">Route:</label>
                <div class="searchable-select" id="previewRouteContainer">
                  <input
                    type="text"
                    id="previewRouteSearch"
                    placeholder="Click to select or type to search routes..."
                    autocomplete="off"
                  />
                  <div class="search-dropdown" id="previewRouteDropdown"></div>
                </div>
              </div>
              <div class="filter-section">
                <label for="previewTripSearch">Trip:</label>
                <div class="searchable-select" id="previewTripContainer">
                  <input
                    type="text"
                    id="previewTripSearch"
                    placeholder="Select route first..."
                    disabled
                    autocomplete="off"
                  />
                  <div class="search-dropdown" id="previewTripDropdown"></div>
                </div>
              </div>
              <div class="filter-actions">
                <button id="previewApplyFilter" class="filter-btn">Show on Map</button>
                <button id="previewClearFilter" class="filter-btn secondary">Clear Filter</button>
              </div>
            </div>
          </div>

          <!-- Preview Map Container -->
          <div id="previewMapContainer" style="height: 400px; width: 100%; margin: 10px 0;"></div>

          <!-- File Statistics -->
          <div class="preview-stats">
            <h4>📈 Data Summary</h4>
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
              <div class="stat-item">
                <div class="stat-value" id="previewStatsAgencies">0</div>
                <div class="stat-label">Agencies</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="previewStatsRoutes">0</div>
                <div class="stat-label">Routes</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="previewStatsTrips">0</div>
                <div class="stat-label">Trips</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="previewStatsStops">0</div>
                <div class="stat-label">Stops</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="previewStatsStopTimes">0</div>
                <div class="stat-label">Stop Times</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="previewStatsServices">0</div>
                <div class="stat-label">Services</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="gtfs-spec.js"></script>
    <script src="gtfs-parser.js"></script>
    <script src="gtfs-editor.js"></script>
    <script src="map-editor.js"></script>
    <script src="app.js"></script>
  </body>
</html>
